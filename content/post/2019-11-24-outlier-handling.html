---
title: 'House-Cleaning: Getting rid of outlier with Gauss'
author: ~
date: '2019-11-24'
slug: outlier-handling
categories: []
tags: []
comments: yes
image: images/tea_with_books.jpg
menu: ''
share: yes
---



<p>Working with real-world data presents many challenges that sanitized data from text book simply don’t have. One of the biggest is how to handle outlier. Now outlier can mean different things. Some outliers are very obvious: someone accidently pressed the zero-key a bit too long and now the standard two-room appartment in an average location has an offering price of three billion euro instead of the more reasonable 300,000€. If you know that the most expensive home in the world (the Buckingham Palace) is valued at around 1.3 billion euro then it is obvious that three billion euro cannot have been the correct offering price. Other cases can be more tricky. What is for example with the old villa in small town offered for 1€? Did the person forget to add some zeros? Or is it one of these run-down houses, maybe in a dying town that someone just wants to get rid of because one would need to invest half a million euro to make the house habitable again?
Similarly, the flat offered for rent for 15,000 euro per months is much more expensive than the average rent and thus might potentially be an outlier, but looking closer, it also has 300sqm and is in a really ncie area, so it might be just a very expensive flat.</p>
<p>So very roughly we can say that there are two categories of outliers:
- outliers that are not real, but instead result from an error or mistake
- outliers that are real, but look extremely different compared with other data.</p>
<p>Now, let’s talk about how we can identify these outliers and how we can clean them from our data.</p>
<p>I recently scraped some rental offers from Immoscout24 and except for throwing away some duplicates that arose probably due to the way I scraped them, this is still very much the raw data and thus still has a bunch of outliers.</p>
<p>The easiest way to see if there are any outliers in your data is to just plot it. Let’s look at the total rent versus the living space:</p>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-4-1.png" /><!-- --></p>
<p>Does this plot remind you of all the times you wanted to have a look at your data, see if there’s any interesting pattern or some insight to be gained just to then be reminded of the fact that your data is still dirty? It definitely does for me. There are some flats or houses that are larger than 10,000 sqm which, according to <a href="https://www.bluebulbprojects.com/MeasureOfThings/results.php?comp=area&amp;unit=m2&amp;amt=10000&amp;sort=pr&amp;p=1">the Measure of Things</a> is twice as big as Bill Gate’s home. And that place with a rent of 10 million? Doesn’t look right.</p>
<p>One way to get a nicer plot, is to just eyeball the axes, use whatever knowledge you have about rents and flats and pick some threshold above or below which you discard the data:</p>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-5-1.png" /><!-- --></p>
<p>It looks better than before but still not great. One could iteratively try smaller thresholds until the blob in the bottom left covers most of the plot area. I think this can be a valid way to obtain reasonable thresholds but might not be very feasible if you have more variables and it’s also not quite satisfying if you like to automate stuff.
In this blog post, I want to describe two simple methods to prune outliers.</p>
<p>The first one is the interquartile range rule and might be familiar to you if you had some classes in statistics.</p>
<div id="interquartile-range-rule" class="section level2">
<h2>Interquartile Range Rule</h2>
<p><a href="https://en.wikipedia.org/wiki/Quartile">Quartiles</a>, are important summary statistics of any continuous data. There are three quartiles, <span class="math inline">\(Q_1\)</span>, <span class="math inline">\(Q_2\)</span> and <span class="math inline">\(Q_3\)</span>, which are the 25th, 50th (the median) and 75th percentiles. The interquartile range <span class="math inline">\(IQR\)</span> is then the difference between the first and third quartile:
<span class="math inline">\(IQR = Q_3 - Q_1\)</span>
The interquartile range thus covers half of the data which is also why they’re used for boxplots: the boxy part is exactly the interquartile range.</p>
<p>A good rule of thumb is to say that every point above <span class="math inline">\(Q_3 +1.5 QR\)</span> or below <span class="math inline">\(Q_1 - 1.5 IQR\)</span> is an outlier.
In python, we can compute this as follows:</p>
<p>For our example, the same plot as above after applying the IQR rule to both our variables then looks like this:</p>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-7-1.png" /><!-- --></p>
<p>Nice! The blob now covers the whole plot area and we get a much better view of the largest chunk of the data.
However, there is a hard, rectangular edge. It looks like we cut off the data too generously and a considereable part of the data is now hidden from view because they’re either larger than 140sqm or more expensive than 1750€ per month. And while I personally wouldn’t rent a flat this expensive, it still sounds like very realistic data and actually not too unachievable. If I would have a flat share with three or four friends, 2000€ would be a reasonable rent in Berlin.</p>
<p>To adjust this rule of thumb, we can increase the factor with which we multiply the IQR. Instead of 1.5, we can use e.g. 2.5:</p>
<pre><code>## &lt;seaborn.axisgrid.JointGrid object at 0x7f63e66b7810&gt;</code></pre>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-8-1.png" /><!-- --></p>
<p>The plot has less cut-off than before but there’s still a rectangular border.
I also added the histograms for each margin to get a look at the individual distributions. One can see that the distribution for the rent does not follow a normal distribution. The distribution for the living space also seems to be slightly right-skewed.
Furthermore, we know that both rents and living space should have values above zero. (There are actually a few observations that have a value of zero for the living space or the total rent. This is clearly not realistic.) So it is probably more reasonable to model both variables assuming a log-normal distribution.
I manually assigned values of 0.5 to the observations that have a value of zero. Seems somehow reasonable to say that there’s not much difference between the rent being 0€ or 50ct.</p>
<pre><code>## [Text(146.29166666666666, 0.5, &#39;totalRent&#39;), Text(0.5, 139.16666666666663, &#39;livingSpace&#39;)]</code></pre>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-9-1.png" /><!-- --></p>
<p>Using the IQR rule on the transformed data, we get the following result:</p>
<pre><code>## [Text(0, 0.5, &#39;totalRent&#39;), Text(0.5, 0, &#39;livingSpace&#39;)]</code></pre>
<pre><code>## [Text(0, 0.5, &#39;totalRent&#39;), Text(0.5, 0, &#39;livingSpace&#39;)]</code></pre>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-10-1.png" /><!-- --></p>
<p>On the left, we see the data after the so identified outliers. Compared to before, the rectangular borders don’t seem as bad as before but they’re still there. On the left, there’s a hard cut throwing away places that are too small. The smallest place that is not considered an outlier has a size of 16.97sqm. Small indeed but it is hard to argue that there couldn’t be smaller flats. One likely problem here is that the data also contains shared flats. The size in the offer would then be the size of the room but the rent would be relatively high compared with a flat of that size (which might not have enough space for a proper kitchen which lowers rent) because in a flat share one also pays for common areas.</p>
<p>On the right, I plotted all data and highlighted outliers in red. It shows that we not only lose data in the lower left corner but there’s also a hard corner in the upper right. One could increase the factor used in the IQR rule but this would still not lead to optimal results.
One problem with the IQR rule is that we apply it separately on each variable. That is, the cut-off window will always be rectangular. In this example though, the two variables are highly correlated and thus a rectangular window is not a good fit. Better would be to use an oval cut-off window.
An oval window as for example obtained by a multivariate Gaussian distribution.</p>
</div>
<div id="gaussian-mixtures-for-outlier-detection" class="section level2">
<h2>Gaussian Mixtures for Outlier Detection</h2>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-11-1.png" /><!-- --></p>
<p>On the left are points sampled from a multivariate normal with a high correlation between the <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> variable, similarly as in our data. The points are colored by their log likelihood. I added one outlier by hand at <span class="math inline">\((-7, -1)\)</span> and as you can see it has a much lower log likelihood compared to the other points. We can use this and classify all points with a very low likelihood as outliers.
On the right, we see the same points where now points with a low likelihood are in red. The grey lines gives the rectangular threshold as obtained from the IQR rule. There are quite a few points at the lower left and upper right corner that would be classified as outlier by the IQR rule whereas it would miss the outlier point I added manually.</p>
<p>Luckily, there’s a package for that: <a href="https://github.com/koaning/scikit-lego">scikit-lego</a>. The package follows the scikit-learn API and adds some additional classifies (such as the Gaussian mixture classifier and outlier detector) but also useful transformers and a pipeline debugger.
The function I’m going to use, fits a multivariate Gaussian to our data, computes the likelihood for each point and points with a low likelihood are flagged as outlier. Vincent, one of the developer of scikit-lego, explains this in a few more sentences in his <a href="http://koaning.io/theme/notebooks/gaussian-progress.pdf">talk</a> which I can recommend.</p>
<pre><code>## Pipeline(memory=None,
##          steps=[(&#39;standardscaler&#39;,
##                  StandardScaler(copy=True, with_mean=True, with_std=True)),
##                 (&#39;bayesiangmmoutlierdetector&#39;,
##                  BayesianGMMOutlierDetector(covariance_prior=None,
##                                             covariance_type=&#39;full&#39;,
##                                             degrees_of_freedom_prior=None,
##                                             init_params=&#39;kmeans&#39;, max_iter=100,
##                                             mean_precision_prior=None,
##                                             mean_prior=None, method=&#39;stddev&#39;,
##                                             n_components=1, n_init=1,
##                                             random_state=None, reg_covar=1e-06,
##                                             threshold=1.5, tol=0.001, verbose=0,
##                                             verbose_interval=10,
##                                             warm_start=False,
##                                             weight_concentration_prior=None,
##                                             weight_concentration_prior_type=&#39;dirichlet_process&#39;))],
##          verbose=False)</code></pre>
<pre><code>## no_outlier    197733
## outlier          646
## Name: outlier, dtype: int64</code></pre>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-16-1.png" /><!-- --></p>
<pre><code>## (-40, 660.0)</code></pre>
<pre><code>## (-1000, 10950.0)</code></pre>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-17-1.png" /><!-- --></p>
<pre><code>##       serviceCharge  ...                                                                                          description
## 58           100.00  ...  WG-ZIMMER UND WOHNUNG:\nSuper zentral gelegen in Ludwigsvorstadt-Isarvorstadt wartet unsere mode...
## 459          100.00  ...  Die Wohnung ist ein echter Volltreffer, denn sie ist modern, hell und zentral.\nSie überzeugt au...
## 649             NaN  ...  *WICHTIGE INFO*:\nDie Raumhöhe liegt unter 2,30 m und entspricht nicht der Landesbauordnung für ...
## 1434          40.00  ...  Helle 1 Zimmer-Wohnung in der Karlsruher Südweststadt. Optimal für einen kleinen Laden, ein Büro...
## 1557         257.50  ...  Für Holzliebhaber!\nDie rustikale 3-Raumwohnung verfügt über ein Tageslichtbad mi Badewanne und ...
## 1679          30.00  ...  Schönes 1-Zimmer-Apartment in einer 3er WG. Eine Gemeinschaftskochnische ist vorhanden, sowie ei...
## 1847         574.44  ...  großzügiges und modernes Loft in Berlin Alt-Kaulsdorf mit etwa 482m²\n\nmoderne Einbauküche inkl...
## 2170          50.00  ...  WG-ZIMMER UND WOHNUNG:\nSuper zentral gelegen im Herzen Frankfurts und in unmittelbarer Nähe zum...
## 2260         110.00  ...  Diese helle 2-Raumwohnung befindet sich im Erdgeschoss in Oberlungwitz.\nAlle Zimmer verfügen üb...
## 2678            NaN  ...  WIR VERMIETEN ALLE 3 WOHNUNGEN NUR IM PAKET UND NICHT EINZEL \nDer Mietvertrag kann NUR mit eine...
## 
## [10 rows x 5 columns]</code></pre>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-22-1.png" /><!-- --></p>
<pre><code>## 348</code></pre>
<pre><code>## (-40, 800.0)</code></pre>
<pre><code>## (-1000, 21266.12)</code></pre>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-24-1.png" /><!-- --></p>
<pre><code>## 2026.0    3
## 2021.0    2
## 2090.0    1
## Name: yearConstructed, dtype: int64</code></pre>
<pre><code>##         totalRent  ...                 regio2
## 1434        490.0  ...              Karlsruhe
## 1557          0.0  ...        Erzgebirgskreis
## 1679        395.0  ...              Karlsruhe
## 2260          0.0  ...          Zwickau_Kreis
## 3112          0.0  ...        Erzgebirgskreis
## ...           ...  ...                    ...
## 194211      245.0  ...          Görlitz_Kreis
## 194559      465.0  ...           Müritz_Kreis
## 196506     1464.0  ...               Solingen
## 196754       25.0  ...  Mühldorf_am_Inn_Kreis
## 196912        0.0  ...    Mittelsachsen_Kreis
## 
## [282 rows x 5 columns]</code></pre>
<pre><code>## (-40, 742.53)</code></pre>
<pre><code>## (-1000, 16300.0)</code></pre>
<p><img src="/post/2019-11-24-outlier-handling_files/figure-html/unnamed-chunk-31-1.png" /><!-- --></p>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<ul>
<li>Outlier detection is hard: what constitutes an outlier if often not very obvious</li>
<li>What to keep and what to throw away often depends on the use case</li>
<li>Transforming highly skewed variables leads to better outcomes, in particular less false positives</li>
<li>Outliers are rare by definition so fitting on a subset can lead to better results</li>
</ul>
</div>
