<!DOCTYPE html>
<html lang="en-us">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
        
        <meta name="twitter:card" content="summary_large_image"/>
        <meta name="twitter:image" content="/images/tea_with_books.jpg"/>
    



<meta name="twitter:title" content="House Cleaning: Getting rid of outliers"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@corrieaar"/>



  	<meta property="og:title" content="House Cleaning: Getting rid of outliers &middot; Samples of Thoughts" />
  	<meta property="og:site_name" content="Samples of Thoughts" />
  	<meta property="og:url" content="/post/house-cleaning-getting-rid-of-outliers/" />

    
       <meta property="og:image" content="/images/tea_with_books.jpg"/>
    
    
    <meta property="og:description" content="" />
  	<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2019-11-23T00:00:00Z" />

    
    

    <title>House Cleaning: Getting rid of outliers &middot; Samples of Thoughts</title>

    
    <meta name="description" content="House-Cleaning: Getting rid of outlier with Gauss Working with real-world data presents many challenges that sanitized data from text book simply don&amp;rsquo;t ha" />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/images/favicon.ico">
	  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="/css/nav.css" />

    

    

    
      
          <link href="/index.xml" rel="alternate" type="application/rss+xml" title="Samples of Thoughts" />
      
      
    
    <meta name="generator" content="Hugo 0.55.6" />

    <link rel="canonical" href="/post/house-cleaning-getting-rid-of-outliers/" />

    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name":  null 
    },
    "author": {
        "@type": "Person",
        "name":  null ,
        
        "url":  null ,
        "sameAs": [
            
            
             
             
             
             
             
            
        ]
    },
    "headline": "House Cleaning: Getting rid of outliers",
    "name": "House Cleaning: Getting rid of outliers",
    "wordCount":  2464 ,
    "timeRequired": "PT12M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": "/post/house-cleaning-getting-rid-of-outliers/",
    "datePublished": "2019-11-23T00:00Z",
    "dateModified": "2019-11-23T00:00Z",
    
    "image": {
        "@type": "ImageObject",
        "url": "/images/tea_with_books.jpg",
        "width": 3000,
        "height": 1445
    },
    
    
    "description": "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/post/house-cleaning-getting-rid-of-outliers/"
    }
}
    </script>
    


    

    
<script type="application/javascript">
var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
var doNotTrack = (dnt == "1" || dnt == "yes");
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-140745376-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>


    
    
    




<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#40485A",
          "text": "#ffffff"
        },
        "button": {
          "background": "#5B5A68",
          "text": "#ffffff"
        }
      },
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on my website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "https://cookies.insites.com"
      }
    })});
</script>


</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
    </ul>

    
    <a class="subscribe-button icon-feed" href="/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">
<link rel="stylesheet" href="/css/googlecode.css" rel="stylesheet" id="theme-stylesheet">
<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



  
  <header class="main-header post-head" style="background-image: url(/images/tea_with_books.jpg)">
  
  <nav class="main-nav overlay clearfix">



      <ul>
       <li> <a class="blog-logo" href="/">Home</a> </li>
        <li> <a class="blog-logo" href="/about">About</a> </li>

            
              <a class="menu-button icon-feed" href="">&nbsp;&nbsp;Subscribe</a>
            
            
      
       </ul>
    </nav>
    
     <div class="vertical">
        <div class="main-header-content inner">
            


    <a class="bloglogo" href="https://github.com/corriebar" target="_blank">
    <span class="icon-github" style="color:white;font-size:2em"></span>
    </a>
&nbsp;









    <a class="bloglogo" href="https://twitter.com/corrieaar" target="_blank">
        <span class="icon-twitter" style="color:white;font-size:2em"></span>
    </a>
&nbsp;














            <h1 class="page-title">Samples of Thoughts</h1>
            <h2 class="page-description">about data, statistics  and everything in between</h2>
        </div>
    </div>  
    


</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">House Cleaning: Getting rid of outliers</h1>
        <small></small>

        <section class="post-meta">
        
            <p class="post-reading post-line">
            <span>Estimated reading time: 12 min</span>
            </p>
        
        
          <time class="post-date" datetime="2019-11-23T00:00:00Z">
            Nov 23, 2019
          </time>
        
        
         
        </section>
    </header>

    <section class="post-content">
      

<h1 id="house-cleaning-getting-rid-of-outlier-with-gauss">House-Cleaning: Getting rid of outlier with Gauss</h1>

<p>Working with real-world data presents many challenges that sanitized data from text book simply don&rsquo;t have. One of the biggest is how to handle outlier. Now outlier can mean different things. Some outliers are very obvious: someone accidently pressed the zero-key a bit too long and now the standard two-room appartment in an average location has an offering price of three billion euro instead of the more reasonable 300,000€. If you know that the most expensive home in the world (the Buckingham Palace) is valued at around 1.3 billion euro then it is obvious that three billion euro cannot have been the correct offering price. Other cases can be more tricky. What is for example with the old villa in small town offered for 1€? Did the person forget to add some zeros? Or is it one of these run-down houses, maybe in a dying town that someone just wants to get rid of because one would need to invest half a million euro to make the house habitable again?
Similarly, the flat offered for rent for 15,000 euro per months is much more expensive than the average rent and thus might potentially be an outlier, but looking closer, it also has 300sqm and is in a really ncie area, so it might be just a very expensive flat.</p>

<p>So very roughly we can say that there are two categories of outliers:
- outliers that are not real, but instead result from an error or mistake
- outliers that are real, but look extremely different compared with other data.</p>

<p>Now, let&rsquo;s talk about how we can identify these outliers and how we can clean them from our data.</p>

<p>I recently scraped some rental offers from Immoscout24 and except for throwing away some duplicates that arose probably due to the way I scraped them, this is still very much the raw data and thus still has a bunch of outliers.</p>

<p>The easiest way to see if there are any outliers in your data is to just plot it. Let&rsquo;s look at the total rent versus the living space:</p>

<p><img src="/post/2019-11-23-house-cleaning-getting-rid-of-outliers_files/Outlier handling_3_1.png" alt="" />
<img src="Outlier%20handling_files/Outlier%20handling_4_0.png" alt="png" /></p>

<p>Does this plot remind you of all the times you wanted to have a look at your data, see if there&rsquo;s any interesting pattern or some insight to be gained just to then be reminded of the fact that your data is still dirty? It definitely does for me. There are some flats or houses that are larger than 10,000 sqm which, according to <a href="https://www.bluebulbprojects.com/MeasureOfThings/results.php?comp=area&amp;unit=m2&amp;amt=10000&amp;sort=pr&amp;p=1">the Measure of Things</a> is twice as big as Bill Gate&rsquo;s home. And that place with a rent of 10 million? Doesn&rsquo;t look right.</p>

<p>One way to get a nicer plot, is to just eyeball the axes, use whatever knowledge you have about rents and flats and pick some threshold above or below which you discard the data:</p>

<pre><code class="language-python">too_large = d[&quot;livingSpace&quot;] &gt; 5000
too_expensive = d[&quot;totalRent&quot;] &gt; 2e5
alrightish = ~too_large &amp; ~too_expensive
fig, ax = plt.subplots(figsize=(9,9))
ax.scatter(d[&quot;livingSpace&quot;][alrightish],d[&quot;totalRent&quot;][alrightish], s=2, alpha=0.8)
ax.set_xlabel(&quot;Living Space (in sqm)&quot;)
ax.set_ylabel(&quot;Total Rent (in €)&quot;)
ax.set_title(&quot;Rent vs Living Space\nNot too large nor too expensive&quot;)
plt.show()
</code></pre>

<p><img src="Outlier%20handling_files/Outlier%20handling_6_0.png" alt="png" /></p>

<p>It looks better than before but still not great. One could iteratively try smaller thresholds until the blob in the bottom left covers most of the plot area. I think this can be a valid way to obtain reasonable thresholds but might not be very feasible if you have more variables and it&rsquo;s also not quite satisfying if you like to automate stuff.
In this blog post, I want to describe two simple methods to prune outliers.</p>

<p>The first one is the interquartile range rule and might be familiar to you if you had some classes in statistics.</p>

<h2 id="interquartile-range-rule">Interquartile Range Rule</h2>

<p><a href="https://en.wikipedia.org/wiki/Quartile">Quartiles</a>, are important summary statistics of any continuous data. There are three quartiles, $Q_1$, $Q_2$ and $Q_3$, which are the 25th, 50th (the median) and 75th percentiles. The interquartile range $IQR$ is then the difference between the first and third quartile:
$IQR = Q_3 - Q_1$
The interquartile range thus covers half of the data which is also why they&rsquo;re used for boxplots: the boxy part is exactly the interquartile range.</p>

<p>A good rule of thumb is to say that every point above $Q_3 +1.5 QR$ or below $Q_1 - 1.5 IQR$ is an outlier.
In python, we can compute this as follows:</p>

<pre><code class="language-python">def iqr(data):
    &quot;&quot;&quot;compute the interquartile range (excluding nan)&quot;&quot;&quot;
    return np.nanquantile(data, 0.75) - np.nanquantile(data, 0.25)

def iqr_rule(data, factor=1.5):
    &quot;&quot;&quot;returns an outlier filter mask using the iqr rule&quot;&quot;&quot;
    iqr_ = iqr(data)
    upper_fence = np.nanquantile(data, 0.75) + factor*iqr_
    lower_fence = np.nanquantile(data, 0.25) - factor*iqr_
    return (data &lt;= upper_fence) &amp; (data &gt;= lower_fence)
</code></pre>

<p>For our example, the same plot as above after applying the IQR rule to both our variables then looks like this:</p>

<pre><code class="language-python">alrightish = iqr_rule(d[&quot;livingSpace&quot;]) &amp; iqr_rule(d[&quot;totalRent&quot;])
fig, ax = plt.subplots(figsize=(9,9))
ax.scatter(d[&quot;livingSpace&quot;][alrightish],d[&quot;totalRent&quot;][alrightish], s=6, alpha=0.6)
ax.set_xlabel(&quot;Living Space (in sqm)&quot;)
ax.set_ylabel(&quot;Total Rent (in €)&quot;)
ax.set_title(&quot;Rent vs Living Space\nIQR rule&quot;)
plt.show()
</code></pre>

<p><img src="Outlier%20handling_files/Outlier%20handling_10_0.png" alt="png" /></p>

<p>Nice! The blob now covers the whole plot area and we get a much better view of the largest chunk of the data.
However, there is a hard, rectangular edge. It looks like we cut off the data too generously and a considereable part of the data is now hidden from view because they&rsquo;re either larger than 140sqm or more expensive than 1750€ per month. And while I personally wouldn&rsquo;t rent a flat this expensive, it still sounds like very realistic data and actually not too unachievable. If I would have a flat share with three or four friends, 2000€ would be a reasonable rent in Berlin.</p>

<p>To adjust this rule of thumb, we can increase the factor with which we multiply the IQR. Instead of 1.5, we can use e.g. 2.5:</p>

<pre><code class="language-python">iqr_rule_25 = lambda x: iqr_rule(x, factor=2.5)
alrightish = iqr_rule_25(d[&quot;livingSpace&quot;]) &amp; iqr_rule_25(d[&quot;totalRent&quot;])
sns.jointplot(x=d[&quot;livingSpace&quot;][alrightish],y=d[&quot;totalRent&quot;][alrightish],
              s=6, alpha=0.6, height=9, marginal_kws=dict(bins=100) )
plt.show()
</code></pre>

<p><img src="Outlier%20handling_files/Outlier%20handling_12_0.png" alt="png" /></p>

<p>The plot has less cut-off than before but there&rsquo;s still a rectangular border.
I also added the histograms for each margin to get a look at the individual distributions. One can see that the distribution for the rent does not follow a normal distribution. The distribution for the living space also seems to be slightly right-skewed.
Furthermore, we know that both rents and living space should have values above zero. (There are actually a few observations that have a value of zero for the living space or the total rent. This is clearly not realistic.) So it is probably more reasonable to model both variables assuming a log-normal distribution.
I manually assigned values of 0.5 to the observations that have a value of zero. Seems somehow reasonable to say that there&rsquo;s not much difference between the rent being 0€ or 50ct.</p>

<pre><code class="language-python">d[&quot;livingSpace_m&quot;] =  np.where(d[&quot;livingSpace&quot;] &lt;= 0, 0.5, d[&quot;livingSpace&quot;])
d[&quot;totalRent_m&quot;] = np.where(d[&quot;totalRent&quot;] &lt;= 0, 0.5, d[&quot;totalRent&quot;])
logbins=np.logspace(0,np.log(10e3),500)
g = sns.jointplot(x=d[&quot;livingSpace_m&quot;],y=d[&quot;totalRent_m&quot;], 
                  s=6, alpha=0.6, height=9, marginal_kws=dict(bins=logbins)
                 )
g.ax_joint.set_yscale(&quot;log&quot;)
g.ax_marg_x.set_xscale(&quot;log&quot;)
g.ax_marg_y.set_xscale(&quot;log&quot;)
g.ax_joint.set_xscale(&quot;log&quot;)
g.ax_joint.set(xlabel=&quot;livingSpace&quot;, ylabel=&quot;totalRent&quot;)
plt.show()
</code></pre>

<p><img src="Outlier%20handling_files/Outlier%20handling_14_0.png" alt="png" /></p>

<p>Using the IQR rule on the transformed data, we get the following result:</p>

<pre><code class="language-python">d[&quot;logRent&quot;] = np.log(d[&quot;totalRent_m&quot;])
d[&quot;logSpace&quot;] = np.log(d[&quot;livingSpace_m&quot;])

fig, ax  = plt.subplots(figsize=(20,9), nrows=1, ncols=2)
alrightish = iqr_rule_25(d[&quot;logSpace&quot;]) &amp; iqr_rule_25(d[&quot;logRent&quot;])
d[&quot;outlier&quot;] = np.where(alrightish, &quot;no_outlier&quot;, &quot;outlier&quot;)
max_space = d[d.outlier == &quot;no_outlier&quot;].livingSpace.max()
max_rent = d[d.outlier == &quot;no_outlier&quot;].totalRent.max()
sns.scatterplot(x=&quot;livingSpace_m&quot;, y=&quot;totalRent_m&quot;, hue=&quot;outlier&quot;, palette=&quot;Set1&quot;,
                hue_order = [&quot;outlier&quot;, &quot;no_outlier&quot;], s=6,
                data=d,  alpha=0.6, ax=ax[1], linewidth=0)
ax[1].set_yscale(&quot;log&quot;)
ax[1].set_xscale(&quot;log&quot;)
ax[1].set(xlabel=&quot;livingSpace&quot;, ylabel=&quot;totalRent&quot;)
ax[1].set_title(&quot;Data with Outliers\n(on log-scale)&quot;)

ax[0].scatter(d[&quot;livingSpace&quot;][alrightish],d[&quot;totalRent&quot;][alrightish], s=6, alpha=0.6)
ax[0].set(xlabel=&quot;livingSpace&quot;, ylabel=&quot;totalRent&quot;)
ax[0].set_title(&quot;Data without Outliers\n(normal scale)&quot;)

plt.show()

</code></pre>

<p><img src="Outlier%20handling_files/Outlier%20handling_16_0.png" alt="png" /></p>

<p>On the left, we see the data after the so identified outliers. Compared to before, the rectangular borders don&rsquo;t seem as bad as before but they&rsquo;re still there. On the left, there&rsquo;s a hard cut throwing away places that are too small. The smallest place that is not considered an outlier has a size of 16.97sqm. Small indeed but it is hard to argue that there couldn&rsquo;t be smaller flats. One likely problem here is that the data also contains shared flats. The size in the offer would then be the size of the room but the rent would be relatively high compared with a flat of that size (which might not have enough space for a proper kitchen which lowers rent) because in a flat share one also pays for common areas.</p>

<p>On the right, I plotted all data and highlighted outliers in red. It shows that we not only lose data in the lower left corner but there&rsquo;s also a hard corner in the upper right. One could increase the factor used in the IQR rule but this would still not lead to optimal results.
One problem with the IQR rule is that we apply it separately on each variable. That is, the cut-off window will always be rectangular. In this example though, the two variables are highly correlated and thus a rectangular window is not a good fit. Better would be to use an oval cut-off window.
An oval window as for example obtained by a multivariate Gaussian distribution.</p>

<h2 id="gaussian-mixtures-for-outlier-detection">Gaussian Mixtures for Outlier Detection</h2>

<pre><code class="language-python">from sklego.mixture import BayesianGMMOutlierDetector

exam = np.random.multivariate_normal([-10, 2], [[1.8, 1.7], [1.7, 2.3]], (1000,))
outlier = [[-7, -1], [-8, 7.5]]
exam = np.vstack([exam, outlier])
mod = BayesianGMMOutlierDetector(n_components=1, threshold=3.5, method=&quot;stddev&quot;).fit(exam)

df_ex= pd.DataFrame({&quot;x1&quot;: exam[:, 0], &quot;x2&quot;: exam[:, 1],
                   &quot;loglik&quot;: mod.score_samples(exam), 
                   &quot;prediction&quot;: mod.predict(exam).astype(str)})

fig, axes = plt.subplots(figsize=(18,7), nrows=1, ncols=2)
axes[0].scatter(df_ex.x1, df_ex.x2, c=df_ex.loglik, cmap=&quot;viridis_r&quot;, s=6)
axes[0].set_title(&quot;Multivariate Normal Distribution&quot;)


factor = 1.5
x1_max = np.nanquantile(exam[:,0], 0.75) + factor*iqr(exam[:,0])
x1_min = np.nanquantile(exam[:,0], 0.25) - factor*iqr(exam[:,0])

x2_max = np.nanquantile(exam[:,1], 0.75) + factor*iqr(exam[:,1])
x2_min = np.nanquantile(exam[:,1], 0.25) - factor*iqr(exam[:,1])


axes[1].scatter(df_ex.x1[df_ex.prediction == &quot;-1&quot;], df_ex.x2[df_ex.prediction == &quot;-1&quot;], c=&quot;red&quot;, label=&quot;low likelihood&quot;, s=6)
axes[1].scatter(df_ex.x1[df_ex.prediction == &quot;1&quot;], df_ex.x2[df_ex.prediction == &quot;1&quot;], c=&quot;steelblue&quot;, s=6)
axes[1].axvline(x=x1_max, c=&quot;grey&quot;, label=&quot;IQR rule&quot;, alpha=0.3)
axes[1].axvline(x=x1_min, c=&quot;grey&quot;, alpha=0.3)
axes[1].axhline(y=x2_max, c=&quot;grey&quot;, alpha=0.3)
axes[1].axhline(y=x2_min, c=&quot;grey&quot;, alpha=0.3)
axes[1].set_title(&quot;IQR rule vs Multivariate Outlier Detector&quot;)
axes[1].legend()
plt.show()
</code></pre>

<p><img src="Outlier%20handling_files/Outlier%20handling_18_0.png" alt="png" /></p>

<p>On the left are points sampled from a multivariate normal with mean $(-10, 2)$ and a covariance matrix of $\Sigma = \bigl( \begin{smallmatrix}1.8 &amp; 1.7\ 1.7 &amp; 2.3\end{smallmatrix}\bigr)$. This leads to a high correlation between the $x$ and $y$ variable, similar as in our data. The points are colored by their log likelihood. I added one outlier by hand at $(-7, -1)$ and as you can see it has a much lower log likelihood compared to the other points. We can use this and classify all points with a very low likelihood as outliers.
On the right, we see the same points where now points with a low likelihood are in red. The grey lines gives the rectangular threshold as obtained from the IQR rule. There are quite a few points at the lower left and upper right corner that would be classified as outlier by the IQR rule whereas it would miss the outlier point I added manually.</p>

<p>Luckily, there&rsquo;s a package for that: <a href="https://github.com/koaning/scikit-lego">scikit-lego</a>. The package follows the scikit-learn API</p>

<pre><code class="language-python">from sklearn.pipeline import make_pipeline
from sklearn.preprocessing import StandardScaler
from sklego.mixture import BayesianGMMOutlierDetector

pipe = make_pipeline(StandardScaler(),
                     BayesianGMMOutlierDetector(n_components=1, threshold=1.5, method=&quot;stddev&quot;) )
</code></pre>

<pre><code class="language-python">num_cols = [&quot;totalRent&quot;, &quot;livingSpace&quot;]
</code></pre>

<pre><code class="language-python">p = 1
sample_size = int(len(d[num_cols]) * p)
sample_idx = np.random.choice(len(d[num_cols]), size=sample_size, replace = False)
</code></pre>

<pre><code class="language-python">pipe.fit(d[num_cols].iloc[sample_idx])
</code></pre>

<pre><code>Pipeline(memory=None,
         steps=[('standardscaler',
                 StandardScaler(copy=True, with_mean=True, with_std=True)),
                ('bayesiangmmoutlierdetector',
                 BayesianGMMOutlierDetector(covariance_prior=None,
                                            covariance_type='full',
                                            degrees_of_freedom_prior=None,
                                            init_params='kmeans', max_iter=100,
                                            mean_precision_prior=None,
                                            mean_prior=None, method='stddev',
                                            n_components=1, n_init=1,
                                            random_state=None, reg_covar=1e-06,
                                            threshold=1.5, tol=0.001, verbose=0,
                                            verbose_interval=10,
                                            warm_start=False,
                                            weight_concentration_prior=None,
                                            weight_concentration_prior_type='dirichlet_process'))],
         verbose=False)
</code></pre>

<pre><code class="language-python">outlier = pipe.predict(d[num_cols])
d[&quot;outlier&quot;] = np.where(outlier == -1, &quot;outlier&quot;, &quot;no_outlier&quot;)
</code></pre>

<pre><code class="language-python">d.outlier.value_counts()
</code></pre>

<pre><code>no_outlier    198375
outlier            4
Name: outlier, dtype: int64
</code></pre>

<pre><code class="language-python">fig, ax  = plt.subplots(figsize=(9,9))
sns.scatterplot(x=&quot;livingSpace&quot;, y=&quot;totalRent&quot;, 
                data=d[d.outlier == &quot;no_outlier&quot;], alpha=0.6, ax=ax, linewidth=0, s=6)
plt.show()
</code></pre>

<p><img src="Outlier%20handling_files/Outlier%20handling_26_0.png" alt="png" /></p>

<pre><code class="language-python">num_cols = [&quot;logRent&quot;, &quot;logSpace&quot;]
</code></pre>

<pre><code class="language-python">p = 1
sample_size = int(len(d[num_cols]) * p)
sample_idx = np.random.choice(len(d[num_cols]), size=sample_size, replace = False)
</code></pre>

<pre><code class="language-python">pipe.fit(d[num_cols].iloc[sample_idx])
</code></pre>

<pre><code>Pipeline(memory=None,
         steps=[('standardscaler',
                 StandardScaler(copy=True, with_mean=True, with_std=True)),
                ('bayesiangmmoutlierdetector',
                 BayesianGMMOutlierDetector(covariance_prior=None,
                                            covariance_type='full',
                                            degrees_of_freedom_prior=None,
                                            init_params='kmeans', max_iter=100,
                                            mean_precision_prior=None,
                                            mean_prior=None, method='stddev',
                                            n_components=1, n_init=1,
                                            random_state=None, reg_covar=1e-06,
                                            threshold=1.5, tol=0.001, verbose=0,
                                            verbose_interval=10,
                                            warm_start=False,
                                            weight_concentration_prior=None,
                                            weight_concentration_prior_type='dirichlet_process'))],
         verbose=False)
</code></pre>

<pre><code class="language-python">outlier = pipe.predict(d[num_cols])
d[&quot;outlier&quot;] = np.where(outlier == -1, &quot;outlier&quot;, &quot;no_outlier&quot;)
</code></pre>

<pre><code class="language-python">d.outlier.value_counts()
</code></pre>

<pre><code>no_outlier    197733
outlier          646
Name: outlier, dtype: int64
</code></pre>

<pre><code class="language-python">fig, ax  = plt.subplots(figsize=(9,9))
sns.scatterplot(x=&quot;livingSpace&quot;, y=&quot;totalRent&quot;, 
                data=d[d.outlier == &quot;no_outlier&quot;], alpha=0.6, ax=ax, linewidth=0, s=6)
plt.show()
</code></pre>

<p><img src="Outlier%20handling_files/Outlier%20handling_32_0.png" alt="png" /></p>

<pre><code class="language-python">fig, ax  = plt.subplots(figsize=(9,9))
max_space = d[d.outlier == &quot;no_outlier&quot;].livingSpace.max()
max_rent = d[d.outlier == &quot;no_outlier&quot;].totalRent.max()
sns.scatterplot(x=&quot;livingSpace&quot;, y=&quot;totalRent&quot;, hue=&quot;outlier&quot;, palette=&quot;Set1&quot;,
                hue_order = [&quot;outlier&quot;, &quot;no_outlier&quot;], s=6,
                data=d,  alpha=0.6, ax=ax, linewidth=0)
ax.set_xlim(-40, max_space + 200)
ax.set_ylim(-1000, max_rent + 800)
plt.show()
</code></pre>

<p><img src="Outlier%20handling_files/Outlier%20handling_33_0.png" alt="png" /></p>

<pre><code class="language-python">
</code></pre>

<pre><code class="language-python">pipe = make_pipeline(PowerTransformer(method=&quot;box-cox&quot;),
                     StandardScaler(),
                     BayesianGMMOutlierDetector(n_components=1, threshold=1.5, method=&quot;stddev&quot;) )
</code></pre>

<pre><code class="language-python">num_cols = [&quot;totalRent_m&quot;, &quot;livingSpace_m&quot;]
</code></pre>

<pre><code class="language-python">p = 1
sample_size = int(len(d[num_cols]) * p)
sample_idx = np.random.choice(len(d[num_cols]), size=sample_size, replace = False)
</code></pre>

<pre><code class="language-python">pipe.fit(d[num_cols].iloc[sample_idx])
</code></pre>

<pre><code>Pipeline(memory=None,
         steps=[('powertransformer',
                 PowerTransformer(copy=True, method='box-cox',
                                  standardize=True)),
                ('standardscaler',
                 StandardScaler(copy=True, with_mean=True, with_std=True)),
                ('bayesiangmmoutlierdetector',
                 BayesianGMMOutlierDetector(covariance_prior=None,
                                            covariance_type='full',
                                            degrees_of_freedom_prior=None,
                                            init_params='kmeans', max_iter=100,
                                            mean_precision_prior=None,
                                            mean_prior=None, method='stddev',
                                            n_components=1, n_init=1,
                                            random_state=None, reg_covar=1e-06,
                                            threshold=1.5, tol=0.001, verbose=0,
                                            verbose_interval=10,
                                            warm_start=False,
                                            weight_concentration_prior=None,
                                            weight_concentration_prior_type='dirichlet_process'))],
         verbose=False)
</code></pre>

<pre><code class="language-python">outlier = pipe.predict(d[num_cols])
d[&quot;outlier&quot;] = np.where(outlier == -1, &quot;outlier&quot;, &quot;no_outlier&quot;)
</code></pre>

<pre><code class="language-python">d.outlier.value_counts()
</code></pre>

<pre><code>no_outlier    197644
outlier          735
Name: outlier, dtype: int64
</code></pre>

<pre><code class="language-python">fig, ax  = plt.subplots(figsize=(9,9))
sns.scatterplot(x=&quot;livingSpace&quot;, y=&quot;totalRent&quot;, 
                data=d[d.outlier == &quot;no_outlier&quot;], alpha=0.6, ax=ax, linewidth=0, s=6)
plt.show()
</code></pre>

<p><img src="Outlier%20handling_files/Outlier%20handling_41_0.png" alt="png" /></p>

<pre><code class="language-python">fig, ax  = plt.subplots(figsize=(9,9))
max_space = d[d.outlier == &quot;no_outlier&quot;].livingSpace.max()
max_rent = d[d.outlier == &quot;no_outlier&quot;].totalRent.max()
sns.scatterplot(x=&quot;livingSpace_m&quot;, y=&quot;totalRent_m&quot;, hue=&quot;outlier&quot;, palette=&quot;Set1&quot;,
                hue_order = [&quot;outlier&quot;, &quot;no_outlier&quot;], s=6,
                data=d,  alpha=0.6, ax=ax, linewidth=0)
#ax.set_xlim(-40, max_space + 200)
#ax.set_ylim(-1000, max_rent + 800)
ax.set_xscale(&quot;log&quot;)
ax.set_yscale(&quot;log&quot;)
plt.show()
</code></pre>

<p><img src="Outlier%20handling_files/Outlier%20handling_42_0.png" alt="png" /></p>

<pre><code class="language-python">
</code></pre>

<pre><code class="language-python">
</code></pre>

<pre><code class="language-python">
</code></pre>

<pre><code class="language-python">Xt = X
for name, transform in pipe.steps[:-1]:
    Xt = transform.transform(Xt)
</code></pre>

<pre><code>----------------------------------------------

NameError    Traceback (most recent call last)

&lt;ipython-input-34-baf3f2ab911a&gt; in &lt;module&gt;
----&gt; 1 Xt = X
      2 for name, transform in pipe.steps[:-1]:
      3     Xt = transform.transform(Xt)


NameError: name 'X' is not defined
</code></pre>

<pre><code class="language-python">d[&quot;loglik&quot;] = pipe.named_steps[&quot;bayesiangmmoutlierdetector&quot;].score_samples(Xt)
fig, ax  = plt.subplots(figsize=(9,9))
sns.scatterplot(x=&quot;livingSpace&quot;, y=&quot;totalRent&quot;, hue=&quot;loglik&quot;, palette=&quot;viridis_r&quot;,
                #hue_order = [&quot;outlier&quot;, &quot;no_outlier&quot;],
                data=d,  alpha=0.6, ax=ax, linewidth=0)
ax.set_xlim(-40, max_space + 200)
ax.set_ylim(-1000, max_rent + 800)
plt.show()
</code></pre>

<pre><code class="language-python">pd.options.display.max_colwidth = 100
d[[&quot;serviceCharge&quot;, &quot;baseRent&quot;, &quot;totalRent&quot;, &quot;livingSpace&quot;, &quot;description&quot;]][d.outlier == &quot;outlier&quot;].head(10)
</code></pre>

<pre><code class="language-python">iterations = 20
num_cols = [&quot;logRent&quot;, &quot;logSpace&quot;]

p = 0.1
sample_size = int(len(d[num_cols]) * p)

outlier_ar = np.empty((0, len(X)) )
for i in range(iterations):
    pipe.fit(X[num_cols].sample(sample_size))

    outlier_ar = np.append(outlier_ar,  [pipe.predict(X[num_cols])], axis=0)
    
outlier = (outlier_ar == -1).mean(axis=0)
</code></pre>

<pre><code class="language-python">outlier_ar
</code></pre>

<pre><code class="language-python">
</code></pre>

<pre><code class="language-python">
</code></pre>

<pre><code class="language-python">
</code></pre>

<pre><code class="language-python">
</code></pre>

<pre><code class="language-python">from sklego.mixture import GMMClassifier, GMMOutlierDetector, BayesianGMMOutlierDetector

exam = np.random.multivariate_normal([-10, 2], [[1, 4],[4, 6]], (2000,))
outlier = [-6, -5]
exam = np.vstack([exam, outlier])
mod = GMMOutlierDetector(n_components=1, threshold=0.99).fit(exam)

df_ex= pd.DataFrame({&quot;x1&quot;: exam[:, 0], &quot;x2&quot;: exam[:, 1],
                   &quot;loglik&quot;: mod.score_samples(exam), 
                   &quot;prediction&quot;: mod.predict(exam).astype(str)})

plt.scatter(df_ex.x1, df_ex.x2, c=df_ex.loglik, cmap=&quot;viridis_r&quot;)
plt.show()
</code></pre>

<pre><code class="language-python">from sklearn.datasets import make_blobs
from sklego.mixture import BayesianGMMClassifier
from scipy.stats import gaussian_kde
from scipy.optimize import minimize_scalar

n_samples = 500

centers = [(-5, -5), (0, 0), (5, 5)]
X, y = make_blobs(n_samples=n_samples, n_features=2, cluster_std=1.0,
                  centers=centers, shuffle=False, random_state=42)


clf = BayesianGMMClassifier()

clf.fit(X, y=y)
</code></pre>

<pre><code class="language-python">y_hat = clf.predict(X)
plt.scatter(X[:,0], X[:,1], c=y_hat, cmap=&quot;Set1&quot;)
plt.show()
</code></pre>

<pre><code class="language-python">threshold = 3.5

res = np.zeros((X.shape[0], clf.classes_.shape[0]))
for idx, c in enumerate(clf.classes_):
    res[:, idx] = clf.gmms_[c].score_samples(X)

for idx, c in enumerate(clf.classes_):
    score_samples = res[y == c, idx]
    density = gaussian_kde(score_samples)
    max_x_value = minimize_scalar(lambda x: -density(x)).x
    mean_likelihood = score_samples.mean()
    new_likelihoods = score_samples[score_samples &lt; max_x_value]
    new_likelihoods_std = np.std(new_likelihoods - mean_likelihood)
    likelihood_threshold_ = mean_likelihood - (threshold * new_likelihoods_std)
    res[:, idx] = -res[:, idx] + likelihood_threshold_
</code></pre>

<pre><code class="language-python">threshold = 0.95

res = np.zeros((X.shape[0], clf.classes_.shape[0]))
for idx, c in enumerate(clf.classes_):
    res[:, idx] = clf.gmms_[c].score_samples(X)

for idx, c in enumerate(clf.classes_):
    score_samples = res[y==c, idx]
    likelihood_threshold_ = np.quantile(score_samples, 1 - threshold)
    
    res[:, idx] = -res[:,idx] + likelihood_threshold_

pred = (res &gt;= 0).astype(int)

y_hat = clf.predict(X)
predm = np.where(pred.mean(axis=1) &gt; 0.9, -1, y_hat)
plt.figure(figsize=(6,6))
for i in range(-1, len(clf.classes_)):
    plt.scatter(X[predm == i,0], X[predm == i,1], label=i)
plt.legend(markerscale=2)
plt.show()
</code></pre>

<pre><code class="language-python">outlier_clf = BayesianGMMOutlierDetector(threshold=0.95, method=&quot;quantile&quot;, n_components=3)
predm = outlier_clf.fit_predict(X)
</code></pre>

<pre><code class="language-python">plt.scatter(X[predm == 1,0], X[predm == 1,1], label=1)
plt.scatter(X[predm == -1,0], X[predm == -1,1], label=-1)
plt.legend()
plt.show()
</code></pre>

<pre><code class="language-python">
</code></pre>

    
    </section>


  <aside class="read-next">
  
      <a class="read-next-story" style="no-cover" href="/post/house-cleaning-getting-rid-of-outliers/">
          <section class="post">
              <h5>House Cleaning: Getting rid of outliers</h5>
              
          </section>
      </a>
  
  
      <a class="read-next-story prev" style="no-cover" href="/post/conference-time-predictive-analytics-world-2019/">
          <section class="post">
              <h5>Conference Time: Predictive Analytics World 2019</h5>
          </section>
      </a>
      

</aside>



  <footer class="post-footer">


    









<section class="author">
  <h4><a href="/">Corrie</a></h4>
  
  <p>Read <a href="/">more posts</a> by this author.</p>
  
  <div class="author-meta">
    
    
  </div>
</section>




    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=House%20Cleaning%3a%20Getting%20rid%20of%20outliers&nbsp;-&nbsp;Samples%20of%20Thoughts&amp;url=%2fpost%2fhouse-cleaning-getting-rid-of-outliers%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=%2fpost%2fhouse-cleaning-getting-rid-of-outliers%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=%2fpost%2fhouse-cleaning-getting-rid-of-outliers%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    

<div id="disqus_thread"></div>
<script>




var disqus_config = function () {
this.page.url = "\/post\/house-cleaning-getting-rid-of-outliers\/";  
this.page.identifier = "\/post\/house-cleaning-getting-rid-of-outliers\/"; 
};

(function() { 
var d = document, s = d.createElement('script');
s.src = 'https://corriebar-github-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>








  </footer>
</article>

</main>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Samples of Thoughts</a> </section>
        
    </footer>
    </div>
    <script type="text/javascript" src="/js/jquery.js"></script>
    <script type="text/javascript" src="/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/js/index.js"></script>
    
    
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
    });
    </script>
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML">
</script>


    
    
<script type="application/javascript">
var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
var doNotTrack = (dnt == "1" || dnt == "yes");
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-140745376-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>

</body>
</html>

