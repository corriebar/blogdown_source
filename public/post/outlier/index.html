<!DOCTYPE html>
<html lang="en-us">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
        
        <meta name="twitter:card" content="summary_large_image"/>
        <meta name="twitter:image" content="/images/tea_with_books.jpg"/>
    



<meta name="twitter:title" content="House-Cleaning: Getting rid of outliers with Gauss"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@corrieaar"/>



  	<meta property="og:title" content="House-Cleaning: Getting rid of outliers with Gauss &middot; Samples of Thoughts" />
  	<meta property="og:site_name" content="Samples of Thoughts" />
  	<meta property="og:url" content="/post/outlier/" />

    
       <meta property="og:image" content="/images/tea_with_books.jpg"/>
    
    
    <meta property="og:description" content="" />
  	<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2020-02-15T00:00:00Z" />

    
    

    <title>House-Cleaning: Getting rid of outliers with Gauss &middot; Samples of Thoughts</title>

    
    <meta name="description" content="House-Cleaning: Getting rid of outliers with Gauss Working with real-world data presents many challenges that sanitized data from text book simply don&amp;rsquo;t h" />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/images/favicon.ico">
	  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="/css/nav.css" />

    

    

    
      
          <link href="/index.xml" rel="alternate" type="application/rss+xml" title="Samples of Thoughts" />
      
      
    
    <meta name="generator" content="Hugo 0.63.1" />

    <link rel="canonical" href="/post/outlier/" />

    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name":  null 
    },
    "author": {
        "@type": "Person",
        "name":  null ,
        
        "url":  null ,
        "sameAs": [
            
            
             
             
             
             
             
            
        ]
    },
    "headline": "House-Cleaning: Getting rid of outliers with Gauss",
    "name": "House-Cleaning: Getting rid of outliers with Gauss",
    "wordCount":  3988 ,
    "timeRequired": "PT19M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": "/post/outlier/",
    "datePublished": "2020-02-15T00:00Z",
    "dateModified": "2020-02-15T00:00Z",
    
    "image": {
        "@type": "ImageObject",
        "url": "/images/tea_with_books.jpg",
        "width": 3000,
        "height": 1445
    },
    
    
    "description": "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/post/outlier/"
    }
}
    </script>
    


    

    
<script type="application/javascript">
var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
var doNotTrack = (dnt == "1" || dnt == "yes");
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-140745376-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>


    
    
    




<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#40485A",
          "text": "#ffffff"
        },
        "button": {
          "background": "#5B5A68",
          "text": "#ffffff"
        }
      },
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on my website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "https://cookies.insites.com"
      }
    })});
</script>


</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
    </ul>

    
    <a class="subscribe-button icon-feed" href="/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">
<link rel="stylesheet" href="/css/googlecode.css" rel="stylesheet" id="theme-stylesheet">
<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



  
 <header class="main-header post-head" style="background-image: url(/images/tea_with_books.jpg)"> 
  
  <nav class="main-nav overlay clearfix">



      <ul>
       <li> <a class="blog-logo" href="/">Home</a> </li>
        <li> <a class="blog-logo" href="/about">About</a> </li>

            
              <a class="menu-button icon-feed" href="">&nbsp;&nbsp;Subscribe</a>
            
            
      
       </ul>
    </nav>
    
     <div class="vertical">
        <div class="main-header-content inner">
            


    <a class="bloglogo" href="https://github.com/corriebar" target="_blank">
    <span class="icon-github" style="color:white;font-size:2em"></span>
    </a>
&nbsp;









    <a class="bloglogo" href="https://twitter.com/corrieaar" target="_blank">
        <span class="icon-twitter" style="color:white;font-size:2em"></span>
    </a>
&nbsp;














            <h1 class="page-title">Samples of Thoughts</h1>
            <h2 class="page-description">about data, statistics  and everything in between</h2>
        </div>
    </div>  
    


</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">House-Cleaning: Getting rid of outliers with Gauss</h1>
        <small></small>

        <section class="post-meta">
        
            <p class="post-reading post-line">
            <span>Estimated reading time: 19 min</span>
            </p>
        
        
          <time class="post-date" datetime="2020-02-15T00:00:00Z">
            Feb 15, 2020
          </time>
        
        
         
        </section>
    </header>

    <section class="post-content">
      <h1 id="house-cleaning-getting-rid-of-outliers-with-gauss">House-Cleaning: Getting rid of outliers with Gauss</h1>
<p>Working with real-world data presents many challenges that sanitized data from text book simply don&rsquo;t have. One of them is how to handle outlier. Outliers are especially common in data obtained through manual input. For example, on an online listing site, someone might have accidently pressed the zero-key a bit too often and suddenly the small appartment for sale is as expensive a palace. However, other outliers can be more tricky. What is for example with the old villa in small town offered for 1€? It might be one of these run-down houses in a dying town and thus could be the actual offering price.</p>
<p>Very roughly we can say that there are two categories of outliers:</p>
<ul>
<li>Outliers that are not real, but instead result from an error or mistake. I&rsquo;ll call them &ldquo;proper outlier&rdquo;.</li>
<li>Outliers that are real, but look extremely different compared with other data. I&rsquo;ll call them &ldquo;improper outlier&rdquo;.</li>
</ul>
<p>Deciding which type of outlier one is dealing with can be difficutl and one usually needs to check the context. Ideally, you&rsquo;ll only want to discard &ldquo;proper outliers&rdquo; and keep the improper ones. However, both types of outlier can be problematic for any subsequent analysis or modelling. In this post, I will focus on identifying outliers in general and won&rsquo;t talk much about distinguishing between the two. Nevertheless, I highly recommend you to always check what type of outlier you&rsquo;re dealing with and to determine the cause of the outlier.
But now let&rsquo;s talk about how we can identify outliers.</p>
<p>A year ago, I scraped some <a href="https://www.kaggle.com/corrieaar/apartment-rental-offers-in-germany">online rental offers</a> and except for throwing away some duplicates that arose probably due to the way I scraped them, this is still very much the raw data and thus still has a bunch of outliers.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> matplotlib <span style="color:#f92672">as</span> mpl
<span style="color:#f92672">import</span> seaborn <span style="color:#f92672">as</span> sns
<span style="color:#f92672">import</span> warnings
warnings<span style="color:#f92672">.</span>filterwarnings(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ignore</span><span style="color:#e6db74">&#39;</span>)

<span style="color:#f92672">from</span> sklearn.mixture <span style="color:#f92672">import</span> GaussianMixture, BayesianGaussianMixture
<span style="color:#f92672">from</span> sklego.mixture <span style="color:#f92672">import</span> GMMClassifier, GMMOutlierDetector
blue <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#008fd5</span><span style="color:#e6db74">&#34;</span>
red <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#fc4f30</span><span style="color:#e6db74">&#34;</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>style<span style="color:#f92672">.</span>use(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">corrie</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">figure.figsize</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">d <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/home/corrie/Documents/Projects/immoscout/data/immo_data_feb_2020.csv</span><span style="color:#e6db74">&#34;</span>)
d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where((d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>isnull()) <span style="color:#f92672">|</span> (d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>),
                          np<span style="color:#f92672">.</span>where( d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">serviceCharge</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>notnull(), d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">baseRent</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">+</span> d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">serviceCharge</span><span style="color:#e6db74">&#34;</span>], d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">baseRent</span><span style="color:#e6db74">&#34;</span>]),
                          d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>])
</code></pre></div><p>The easiest way to see if there are any outliers in your data is to just plot it. Let&rsquo;s look at the total rent versus the living space:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>))
ax<span style="color:#f92672">.</span>scatter(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>],d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>], s<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Living Space [sqm]</span><span style="color:#e6db74">&#34;</span>)
ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Total Rent [€]</span><span style="color:#e6db74">&#34;</span>)
ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Rent vs Living Space</span><span style="color:#e6db74">&#34;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="content/post/Outlier%20handling_files/Outlier%20handling_5_0.png" alt="png"></p>
<p>Does this plot remind you of all the times you wanted to have a quick look at your data, see if there&rsquo;s any interesting pattern or some insight to be gained just to then be reminded of the fact that your data is still dirty? It definitely does for me. There are some flats or houses that are larger than 10,000 sqm which, according to <a href="https://www.bluebulbprojects.com/MeasureOfThings/results.php?comp=area&amp;unit=m2&amp;amt=10000&amp;sort=pr&amp;p=1">the Measure of Things</a> is twice as big as Bill Gate&rsquo;s home. And that place with a rent of 10 million? Doesn&rsquo;t look right.</p>
<p>One way to get a nicer plot, is to just eyeball the axes, use whatever knowledge you have about rents and flats and pick some threshold above or below which you discard the data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">too_large <span style="color:#f92672">=</span> d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">5000</span>
too_expensive <span style="color:#f92672">=</span> d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2e5</span>
alrightish <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>too_large <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>too_expensive
fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>))
ax<span style="color:#f92672">.</span>scatter(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>][alrightish],d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>][alrightish], s<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.8</span>)
ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Living Space [sqm]</span><span style="color:#e6db74">&#34;</span>)
ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Total Rent [€]</span><span style="color:#e6db74">&#34;</span>)
ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Rent vs Living Space</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Not too large nor too expensive</span><span style="color:#e6db74">&#34;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="Outlier%20handling_files/Outlier%20handling_7_0.png" alt="png"></p>
<p>It looks better than before but still not great. One could iteratively try smaller thresholds until the blob in the bottom left covers most of the plot area. I think this can be a valid way to obtain reasonable thresholds but might not be very feasible if you have more variables and it&rsquo;s also not quite satisfying if you like to automate stuff.
In this blog post, I want to describe two simple methods to prune outliers.</p>
<p>The first one is the interquartile range rule and might be familiar to you if you had some classes in statistics.</p>
<h2 id="interquartile-range-rule">Interquartile Range Rule</h2>
<p><a href="https://en.wikipedia.org/wiki/Quartile">Quartiles</a> are important summary statistics of any continuous data. There are three quartiles, $Q_1$, $Q_2$ and $Q_3$, which are the 25th, 50th (the median) and 75th percentiles. The interquartile range $IQR$ is then the difference between the first and third quartile:
$IQR = Q_3 - Q_1$
The interquartile range thus covers half of the data which is also why they&rsquo;re used for boxplots: the boxy part is exactly the interquartile range.</p>
<p>A good rule of thumb is to say that every point above $Q_3 +1.5 IQR$ or below $Q_1 - 1.5 IQR$ is an outlier.
In python, we can compute this as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">iqr</span>(data):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">compute the interquartile range (excluding nan)</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>nanquantile(data, <span style="color:#ae81ff">0.75</span>) <span style="color:#f92672">-</span> np<span style="color:#f92672">.</span>nanquantile(data, <span style="color:#ae81ff">0.25</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">iqr_rule</span>(data, factor<span style="color:#f92672">=</span><span style="color:#ae81ff">1.5</span>):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">returns an outlier filter mask using the iqr rule</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
    iqr_ <span style="color:#f92672">=</span> iqr(data)
    upper_fence <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nanquantile(data, <span style="color:#ae81ff">0.75</span>) <span style="color:#f92672">+</span> factor<span style="color:#f92672">*</span>iqr_
    lower_fence <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nanquantile(data, <span style="color:#ae81ff">0.25</span>) <span style="color:#f92672">-</span> factor<span style="color:#f92672">*</span>iqr_
    <span style="color:#66d9ef">return</span> (data <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> upper_fence) <span style="color:#f92672">&amp;</span> (data <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> lower_fence)
</code></pre></div><p>For our example, the same plot as above after applying the IQR rule to both our variables then looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">alrightish <span style="color:#f92672">=</span> iqr_rule(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>]) <span style="color:#f92672">&amp;</span> iqr_rule(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>])
fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>))
ax<span style="color:#f92672">.</span>scatter(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>][alrightish],d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>][alrightish], s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>)
ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Living Space [sqm]</span><span style="color:#e6db74">&#34;</span>)
ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Total Rent [€]</span><span style="color:#e6db74">&#34;</span>)
ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Rent vs Living Space</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">IQR rule</span><span style="color:#e6db74">&#34;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="Outlier%20handling_files/Outlier%20handling_11_0.png" alt="png"></p>
<p>Nice! The blob now covers the whole plot area and we get a much better view of the largest chunk of the data.
However, there is a hard, rectangular edge. It looks like we cut off the data too generously and a considereable part of the data is now hidden from view because they&rsquo;re either larger than 140sqm or more expensive than 1750€ per month. And while I personally wouldn&rsquo;t rent a flat this expensive, it still sounds like very realistic rents and sizes. If I would have a flat share with three or four friends, 2000€ seems like a reasonable rent in Berlin.</p>
<p>To adjust this rule of thumb, we can increase the factor with which we multiply the IQR. Instead of 1.5, we can use e.g. 2.5:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">iqr_rule_25 <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x: iqr_rule(x, factor<span style="color:#f92672">=</span><span style="color:#ae81ff">2.5</span>)
alrightish <span style="color:#f92672">=</span> iqr_rule_25(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>]) <span style="color:#f92672">&amp;</span> iqr_rule_25(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>])
g <span style="color:#f92672">=</span> sns<span style="color:#f92672">.</span>jointplot(x<span style="color:#f92672">=</span>d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>][alrightish],y<span style="color:#f92672">=</span>d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>][alrightish],
              s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>, height<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>, marginal_kws<span style="color:#f92672">=</span>dict(bins<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>) )
g <span style="color:#f92672">=</span> g<span style="color:#f92672">.</span>ax_joint<span style="color:#f92672">.</span>set(xlabel<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Living Space [sqm]</span><span style="color:#e6db74">&#34;</span>, ylabel<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Total Rent [€]</span><span style="color:#e6db74">&#34;</span>)

plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="Outlier%20handling_files/Outlier%20handling_13_0.png" alt="png"></p>
<p>The plot has less cut-off than before but there&rsquo;s still a rectangular border.
I also added the histograms for each margin to get a look at the individual distributions. One can see that the distribution for the rent does not follow a normal distribution but is highly right-skewed. The distribution for the living space also seems to be slightly right-skewed.
Furthermore, we know that both rents and living space should only have values strictly above zero. (There are actually a few observations that have a value of zero for the living space or the total rent. This is clearly not realistic.) So it is probably more reasonable to model both variables assuming a log-normal distribution.
I manually assigned values of 0.5 to the observations that have a value of zero. Seems somehow reasonable to say that there&rsquo;s not much difference between the rent being 0€ or 50ct.
Let&rsquo;s look at the whole data again but this time with log-transformed rent and living space:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace_m</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span>  np<span style="color:#f92672">.</span>where(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.5</span>, d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>])
d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent_m</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.5</span>, d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>])
logbins<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>logspace(<span style="color:#ae81ff">0</span>,np<span style="color:#f92672">.</span>log(<span style="color:#ae81ff">10e3</span>),<span style="color:#ae81ff">500</span>)
g <span style="color:#f92672">=</span> sns<span style="color:#f92672">.</span>jointplot(x<span style="color:#f92672">=</span>d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace_m</span><span style="color:#e6db74">&#34;</span>],y<span style="color:#f92672">=</span>d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent_m</span><span style="color:#e6db74">&#34;</span>], 
                  s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>, height<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>, marginal_kws<span style="color:#f92672">=</span>dict(bins<span style="color:#f92672">=</span>logbins)
                 )
g<span style="color:#f92672">.</span>ax_joint<span style="color:#f92672">.</span>set_yscale(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">log</span><span style="color:#e6db74">&#34;</span>)
g<span style="color:#f92672">.</span>ax_joint<span style="color:#f92672">.</span>set_xscale(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">log</span><span style="color:#e6db74">&#34;</span>)
g<span style="color:#f92672">.</span>ax_joint<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Living Space [sqm]</span><span style="color:#e6db74">&#34;</span>)
g<span style="color:#f92672">.</span>ax_joint<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Total Rent [€]</span><span style="color:#e6db74">&#34;</span>)
g<span style="color:#f92672">.</span>ax_marg_x<span style="color:#f92672">.</span>set_xscale(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">log</span><span style="color:#e6db74">&#34;</span>)
g<span style="color:#f92672">.</span>ax_marg_y<span style="color:#f92672">.</span>set_xscale(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">log</span><span style="color:#e6db74">&#34;</span>)
plt<span style="color:#f92672">.</span>subplots_adjust(top<span style="color:#f92672">=</span><span style="color:#ae81ff">0.9</span>)
plt<span style="color:#f92672">.</span>suptitle(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Log-Transformed Data</span><span style="color:#e6db74">&#34;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="Outlier%20handling_files/Outlier%20handling_15_0.png" alt="png"></p>
<p>Note that this is the same plot as our first one, just in log-scale. So only transforming the data already brought a big improvement.</p>
<p>Now using the IQR rule on the transformed data, we get the following result:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logRent</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>log(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent_m</span><span style="color:#e6db74">&#34;</span>])
d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logSpace</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>log(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace_m</span><span style="color:#e6db74">&#34;</span>])

fig, ax  <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">20</span>,<span style="color:#ae81ff">9</span>), nrows<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, ncols<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
alrightish <span style="color:#f92672">=</span> iqr_rule_25(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logSpace</span><span style="color:#e6db74">&#34;</span>]) <span style="color:#f92672">&amp;</span> iqr_rule_25(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logRent</span><span style="color:#e6db74">&#34;</span>])
d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(alrightish, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>)
max_space <span style="color:#f92672">=</span> d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>livingSpace<span style="color:#f92672">.</span>max()
max_rent <span style="color:#f92672">=</span> d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>totalRent<span style="color:#f92672">.</span>max()
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>scatter(x<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>livingSpace_m, c<span style="color:#f92672">=</span>red, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
              y<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>totalRent_m, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Outlier</span><span style="color:#e6db74">&#34;</span>, s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)

ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>scatter(x<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>livingSpace_m, c<span style="color:#f92672">=</span>blue, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
              y<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>totalRent_m, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Not Outlier</span><span style="color:#e6db74">&#34;</span>, s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)

ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Living Space [sqm]</span><span style="color:#e6db74">&#34;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Total Rent [€]</span><span style="color:#e6db74">&#34;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set_yscale(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">log</span><span style="color:#e6db74">&#34;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set_xscale(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">log</span><span style="color:#e6db74">&#34;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Data with Outliers</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">(on log-scale)</span><span style="color:#e6db74">&#34;</span>)
leg <span style="color:#f92672">=</span> ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>legend(markerscale<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)
<span style="color:#66d9ef">for</span> lh <span style="color:#f92672">in</span> leg<span style="color:#f92672">.</span>legendHandles:
    lh<span style="color:#f92672">.</span>set_alpha(<span style="color:#ae81ff">1</span>)

ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>scatter(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>][alrightish],d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>][alrightish], s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>)
ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>)
ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>)
ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Data without Outliers</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">(normal scale)</span><span style="color:#e6db74">&#34;</span>)

plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="Outlier%20handling_files/Outlier%20handling_17_0.png" alt="png"></p>
<p>On the left, we see the data after removing the so identified outliers. The rectangular borders don&rsquo;t seem as bad as before but they&rsquo;re still there. Especially in the bottom left, there&rsquo;s a hard cut throwing away places that are too small. The smallest place that is not considered an outlier has a size of 16.97sqm. As often with thresholds, there remains the question why a flat of size 16.97sqm is okay but many flats of size 16.6sqm are not. One problem here is that the data likely also contains many shared flats. The size in the offer would then be the size of the room but the rent would be relatively high for such a small living area since one also pays for common areas in a shared flat.</p>
<p>On the right, I plotted all data and highlighted outliers in red. In total, around 1500 data points were classified as outliers. This is less than 1% of the total data.
In the right plot we can see that we not only lose data in the lower left corner but there&rsquo;s also a hard corner in the upper right. One could increase the factor used in the IQR rule but this would still not lead to optimal results.
One problem with the IQR rule is that we apply it separately on each variable. That is, the cut-off window will always be rectangular. In this example though, the two variables are highly correlated and thus a rectangular window is not a good fit. Better would be to use an oval cut-off window.
Such an oval window can for example be obtained by a multivariate Gaussian distribution.</p>
<h2 id="gaussian-mixtures-for-outlier-detection">Gaussian Mixtures for Outlier Detection</h2>
<p>So how does this work? We first fit a <a href="https://en.wikipedia.org/wiki/Multivariate_normal_distribution">multivariate normal distribution</a> on our data and then compute the likelihood for each data point according to this distribution. All data points with a very low likelihood, much lower than the other data points, are then classified as outliers. Let&rsquo;s visualize this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># thanks joseph https://joseph-long.com/writing/colorbars/</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">colorbar</span>(mappable, label):
    <span style="color:#f92672">from</span> mpl_toolkits.axes_grid1 <span style="color:#f92672">import</span> make_axes_locatable
    last_axes <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>gca()
    ax <span style="color:#f92672">=</span> mappable<span style="color:#f92672">.</span>axes
    fig <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>figure
    divider <span style="color:#f92672">=</span> make_axes_locatable(ax)
    cax <span style="color:#f92672">=</span> divider<span style="color:#f92672">.</span>append_axes(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">right</span><span style="color:#e6db74">&#34;</span>, size<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">5</span><span style="color:#e6db74">%</span><span style="color:#e6db74">&#34;</span>, pad<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>)
    cbar <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>colorbar(mappable, cax<span style="color:#f92672">=</span>cax, label<span style="color:#f92672">=</span>label)
    plt<span style="color:#f92672">.</span>sca(last_axes)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> sklego.mixture <span style="color:#f92672">import</span> BayesianGMMOutlierDetector

np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">20</span>)
exam <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>multivariate_normal([<span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">2</span>], [[<span style="color:#ae81ff">1.8</span>, <span style="color:#ae81ff">1.7</span>], [<span style="color:#ae81ff">1.7</span>, <span style="color:#ae81ff">2.3</span>]], (<span style="color:#ae81ff">1000</span>,))
outlier <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([[<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], [<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">7.5</span>]])
exam <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>vstack([exam, outlier])
mod <span style="color:#f92672">=</span> BayesianGMMOutlierDetector(n_components<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, threshold<span style="color:#f92672">=</span><span style="color:#ae81ff">3.5</span>, method<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">.</span>fit(exam)

df_ex<span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">x1</span><span style="color:#e6db74">&#34;</span>: exam[:, <span style="color:#ae81ff">0</span>], <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">x2</span><span style="color:#e6db74">&#34;</span>: exam[:, <span style="color:#ae81ff">1</span>],
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">loglik</span><span style="color:#e6db74">&#34;</span>: <span style="color:#f92672">-</span>mod<span style="color:#f92672">.</span>score_samples(exam), 
                   <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">prediction</span><span style="color:#e6db74">&#34;</span>: mod<span style="color:#f92672">.</span>predict(exam)<span style="color:#f92672">.</span>astype(str)})
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fig, axes <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">20</span>,<span style="color:#ae81ff">7</span>), nrows<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, ncols<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
norm <span style="color:#f92672">=</span> mpl<span style="color:#f92672">.</span>colors<span style="color:#f92672">.</span>Normalize(vmin<span style="color:#f92672">=</span>df_ex<span style="color:#f92672">.</span>loglik<span style="color:#f92672">.</span>min(),vmax<span style="color:#f92672">=</span>df_ex<span style="color:#f92672">.</span>loglik<span style="color:#f92672">.</span>max())
scatter <span style="color:#f92672">=</span> axes[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>scatter(df_ex<span style="color:#f92672">.</span>x1, df_ex<span style="color:#f92672">.</span>x2, 
                          c<span style="color:#f92672">=</span>df_ex<span style="color:#f92672">.</span>loglik, cmap<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">viridis</span><span style="color:#e6db74">&#34;</span>, norm<span style="color:#f92672">=</span>norm,
                          s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">log-likelihood</span><span style="color:#e6db74">&#34;</span>)
colorbar(scatter, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">log-likelihood</span><span style="color:#e6db74">&#34;</span>)
axes[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>scatter(outlier[:,<span style="color:#ae81ff">0</span>], outlier[:,<span style="color:#ae81ff">1</span>], 
                c<span style="color:#f92672">=</span>df_ex<span style="color:#f92672">.</span>loglik[<span style="color:#ae81ff">1000</span>:] ,cmap<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">viridis</span><span style="color:#e6db74">&#34;</span>, norm<span style="color:#f92672">=</span>norm,
                s<span style="color:#f92672">=</span><span style="color:#ae81ff">35</span>)
axes[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Multivariate Normal Distribution</span><span style="color:#e6db74">&#34;</span>)



factor <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>
x1_max <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nanquantile(exam[:,<span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">0.75</span>) <span style="color:#f92672">+</span> factor<span style="color:#f92672">*</span>iqr(exam[:,<span style="color:#ae81ff">0</span>])
x1_min <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nanquantile(exam[:,<span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">0.25</span>) <span style="color:#f92672">-</span> factor<span style="color:#f92672">*</span>iqr(exam[:,<span style="color:#ae81ff">0</span>])

x2_max <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nanquantile(exam[:,<span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">0.75</span>) <span style="color:#f92672">+</span> factor<span style="color:#f92672">*</span>iqr(exam[:,<span style="color:#ae81ff">1</span>])
x2_min <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nanquantile(exam[:,<span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">0.25</span>) <span style="color:#f92672">-</span> factor<span style="color:#f92672">*</span>iqr(exam[:,<span style="color:#ae81ff">1</span>])


axes[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>scatter(df_ex<span style="color:#f92672">.</span>x1[df_ex<span style="color:#f92672">.</span>prediction <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-1</span><span style="color:#e6db74">&#34;</span>], df_ex<span style="color:#f92672">.</span>x2[df_ex<span style="color:#f92672">.</span>prediction <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-1</span><span style="color:#e6db74">&#34;</span>], c<span style="color:#f92672">=</span>red, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">low likelihood</span><span style="color:#e6db74">&#34;</span>, s<span style="color:#f92672">=</span><span style="color:#ae81ff">35</span>)
axes[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>scatter(df_ex<span style="color:#f92672">.</span>x1[df_ex<span style="color:#f92672">.</span>prediction <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#34;</span>], df_ex<span style="color:#f92672">.</span>x2[df_ex<span style="color:#f92672">.</span>prediction <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#34;</span>], c<span style="color:#f92672">=</span>blue, s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)
axes[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>axvline(x<span style="color:#f92672">=</span>x1_max, c<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">grey</span><span style="color:#e6db74">&#34;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IQR rule</span><span style="color:#e6db74">&#34;</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
axes[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>axvline(x<span style="color:#f92672">=</span>x1_min, c<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">grey</span><span style="color:#e6db74">&#34;</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
axes[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>axhline(y<span style="color:#f92672">=</span>x2_max, c<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">grey</span><span style="color:#e6db74">&#34;</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
axes[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>axhline(y<span style="color:#f92672">=</span>x2_min, c<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">grey</span><span style="color:#e6db74">&#34;</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
axes[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IQR rule vs Multivariate Outlier Detector</span><span style="color:#e6db74">&#34;</span>)
axes[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>legend(markerscale<span style="color:#f92672">=</span><span style="color:#ae81ff">1.5</span>, bbox_to_anchor<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1.01</span>, <span style="color:#f92672">.</span><span style="color:#ae81ff">6</span>))
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="Outlier%20handling_files/Outlier%20handling_21_0.png" alt="png"></p>
<p>On the left are points sampled from a multivariate normal with a high correlation between the $x$ and $y$ variable, similarly as in our data. The points are colored by their log likelihood. I added two outliers by hand, plotted slightly larger on the left, and as you can see they have a much lower log likelihood compared to the other points. We can use this and classify all points with a very low likelihood as outliers.
On the right, we see the same points where now all points with a low likelihood are in red. The grey lines gives the rectangular threshold as obtained from the IQR rule. There are quite a few points at the lower left and upper right corner that would be classified as outlier by the IQR rule whereas it would miss at least one of the manually added outlier points.</p>
<p>Luckily, there&rsquo;s a package for that: <a href="https://github.com/koaning/scikit-lego">scikit-lego</a>. The package follows the scikit-learn API and adds some additional classifiers (such as the Gaussian mixture classifier and outlier detector) but also useful transformers and a pipeline debugger.
The function I&rsquo;m going to use does the whole procedure described above: it fits a multivariate Gaussian to our data, computes the likelihood for each point and points with a low likelihood are flagged as outlier. Vincent, one of the developer of scikit-lego, explains this in a few more sentences in his <a href="https://www.youtube.com/watch?v=aICqoAG5BXQ">talk</a> which I can definitely recommend.</p>
<p>Let&rsquo;s apply this to our data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> sklearn.pipeline <span style="color:#f92672">import</span> make_pipeline
<span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> StandardScaler
<span style="color:#f92672">from</span> sklego.mixture <span style="color:#f92672">import</span> BayesianGMMOutlierDetector

num_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logRent</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logSpace</span><span style="color:#e6db74">&#34;</span>]

pipe <span style="color:#f92672">=</span> make_pipeline(StandardScaler(),
                     BayesianGMMOutlierDetector(threshold<span style="color:#f92672">=</span><span style="color:#ae81ff">1.5</span>, method<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev</span><span style="color:#e6db74">&#34;</span>) )

pipe <span style="color:#f92672">=</span> pipe<span style="color:#f92672">.</span>fit(d[num_cols])
outlier <span style="color:#f92672">=</span> pipe<span style="color:#f92672">.</span>predict(d[num_cols])

d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(outlier <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>)

d<span style="color:#f92672">.</span>outlier<span style="color:#f92672">.</span>value_counts()
</code></pre></div><pre><code>no_outlier    267105
outlier         1745
Name: outlier, dtype: int64
</code></pre>
<p>The Gaussian mixture outlier dectetor classified slightly more points as outlier than the IQR rule. In percentage, this is still less than 1% though.
Let&rsquo;s visualize which points we would lose as outliers:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>))
max_space <span style="color:#f92672">=</span> d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>livingSpace<span style="color:#f92672">.</span>max()
max_rent <span style="color:#f92672">=</span> d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>totalRent<span style="color:#f92672">.</span>max()
ax<span style="color:#f92672">.</span>scatter(x<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>livingSpace_m, c<span style="color:#f92672">=</span>blue, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
              y<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>totalRent_m, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Not Outlier</span><span style="color:#e6db74">&#34;</span>, s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)
ax<span style="color:#f92672">.</span>scatter(x<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>livingSpace_m, c<span style="color:#f92672">=</span>red, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
              y<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>totalRent_m, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Outlier</span><span style="color:#e6db74">&#34;</span>, s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)
left, right <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>set_xlim(<span style="color:#f92672">-</span><span style="color:#ae81ff">40</span>, max_space <span style="color:#f92672">+</span> <span style="color:#ae81ff">200</span>)
bottom, top <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>set_ylim(<span style="color:#f92672">-</span><span style="color:#ae81ff">500</span>, max_rent <span style="color:#f92672">+</span> <span style="color:#ae81ff">800</span>)
ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Using GMM for Outlier Detection</span><span style="color:#e6db74">&#34;</span>)
leg <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>legend(markerscale<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)
<span style="color:#66d9ef">for</span> lh <span style="color:#f92672">in</span> leg<span style="color:#f92672">.</span>legendHandles:
    lh<span style="color:#f92672">.</span>set_alpha(<span style="color:#ae81ff">1</span>)
ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Living Space [sqm]</span><span style="color:#e6db74">&#34;</span>)
ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Total Rent [€]</span><span style="color:#e6db74">&#34;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="Outlier%20handling_files/Outlier%20handling_25_0.png" alt="png"></p>
<p>Especially in the upper right we can see that the cut-off window is now elliptic instead of rectangular. Also good to see that points with a living space above 200sqm with rents below 1000€ are classified as outliers. That seems reasonable for me. Same for flat with a living space less than 80sqm with a rent above 2000€ or 3000€. Also seems reasonable.
However, in the lower left we see again a rather hard threshold going through our blob of data points. That doesn&rsquo;t look much better to what we had before. Indeed, if we look at some outliers from the lower left, we find some (depressing) realistic examples, such as this tiny flat in one of the most popular areas of Munich, newly renovated with high quality furniture for a total rent of 900€. Depressingly expensive but not unrealistic.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pd<span style="color:#f92672">.</span>options<span style="color:#f92672">.</span>display<span style="color:#f92672">.</span>max_colwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
ex1 <span style="color:#f92672">=</span> d[[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">description</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">regio2</span><span style="color:#e6db74">&#34;</span>]][d<span style="color:#f92672">.</span>outlier <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]
<span style="color:#66d9ef">print</span>(ex1[[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">regio2</span><span style="color:#e6db74">&#34;</span>]]); ex1<span style="color:#f92672">.</span>description[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">545</span>]
</code></pre></div><pre><code>totalRent          900
livingSpace         18
regio2         München
Name: 46, dtype: object





'Ein kleiner möblierter Traum zwischen Englischem Garten und Münchner Freiheit.  In dieser kürzlich kernsanierten kleinen Wohnung ist buchstäblich alles neu. Vom hochwertigen Bad mit großem Handtuchwärmer, über die neue Einbauküche aus dem Küchenstudio, die wunderschönen Landhausdielen aus massivem Eichenholz, dem neuen großen Fenster mit elektrischer Rollladensteuerung in den ruhigen Innenhof, bis hin zu den Möbeln, Lampen und dem internetfähigen TV.\n\nKosten für Strom, Heizung und Kabelfernsehen sind in den Nebenkosten bereits enthalten.\n\n'
</code></pre>
<h2 id="gaussian-mixtures-enhanced">Gaussian Mixtures enhanced</h2>
<p>Personally, I prefer to throw away as little as possible. So I would like to keep points such as the one above in my data set. Also, imagine we would want to analyse afterwards how rent prices developed in Munich. Throwing out these examples would make Munich look cheaper than it actually is.
One option would be to now play around with the threshold until you get a result you like. I often found this to be very difficult and the results not necessarily very satisfying. One problem I also encountered is that some outliers that are really very far out there (think e.g. a rent of 120,000€), these points influenced the fitting algorithm so that the fitted multivariate normal distribution was very wide. This then would mean that quite a few real outliers would easily be missed when increasing the threshold.
So I came up with the following method:
What if instead of fitting on the whole data set, we only fit the outlier detector on a small subset. After all, outliers are by definition rare and when we fit on a small subsample there is a high probability that it doesn&rsquo;t contain outliers which then makes it easier to detect outliers. However, you might easily be unlucky with the random sample you got, either then finding way too many or too little outliers. Thus, instead of just sampling and fitting once, I repeatedly sample and fit. Each time fitting on a small sample, predicting on the whole data, and then taking the mean of how often a point was classified as an outlier. This way, I also get a probability how likely a point is to be an outlier! Neat!</p>
<p>I experimented a bit which settings go best and I found that for a data set as big as this one, fitting on 1% of the data gives good results. For the number of iterations, I&rsquo;m using 100 here but found 30 to 40 iterations to also work fine. I have found 30 iterations to be the lowest number of iterations that still gives relatively stable results. If you use lower number of iterations, you&rsquo;ll might end up with a very different number of outliers each time you run it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">prob_outlier</span>(outlier_detector_pipe, data, iterations<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, p<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>):
    sample_size <span style="color:#f92672">=</span> int(len(data) <span style="color:#f92672">*</span> p)

    outlier_ar <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>empty((<span style="color:#ae81ff">0</span>, len(data)) )
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(iterations):
        outlier_detector_pipe<span style="color:#f92672">.</span>fit(data<span style="color:#f92672">.</span>sample(sample_size))

        outlier_ar <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>append(outlier_ar,  [outlier_detector_pipe<span style="color:#f92672">.</span>predict(data)], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)

    outlier <span style="color:#f92672">=</span> (outlier_ar <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>mean(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
    <span style="color:#66d9ef">return</span> outlier

num_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logRent</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logSpace</span><span style="color:#e6db74">&#34;</span>]

d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> prob_outlier(pipe, d[num_cols])
</code></pre></div><p>After thus obtaining outlier probabilities, we can have a short look at the distribution of these probabilities:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">hist <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>hist(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>], log<span style="color:#f92672">=</span>True, bins<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>, ec<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">darkblue</span><span style="color:#e6db74">&#34;</span>)
plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Distribution over outlier probabilities</span><span style="color:#e6db74">&#34;</span>)
plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Probability</span><span style="color:#e6db74">&#34;</span>)
plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Counts (in log scale)</span><span style="color:#e6db74">&#34;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="Outlier%20handling_files/Outlier%20handling_31_0.png" alt="png"></p>
<p>Most points are never classified as outliers, makes sense, most points should not be outlier. There is a small number of points that always get classified as outliers, these are the points where we can be very sure that they&rsquo;re outliers.
I will use a rather conservative threshold and declare everything above 0.97 as outlier:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">np<span style="color:#f92672">.</span>sum(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.97</span>)
</code></pre></div><pre><code>474
</code></pre>
<p>Remember, with the IQR rule we identified ~1500 outliers and with the Gaussian mixture ~1700. We reduced the number of outliers by more than half! If you care about throwing away as little as possible, this is great! And even if you want to throw away more, it is very easy to change the threshold to be less conservative.</p>
<p>Let&rsquo;s have a look at the points we detect as outliers:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fig, ax  <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>))
d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier_pred</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.97</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>)
max_space <span style="color:#f92672">=</span> d[d<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>livingSpace<span style="color:#f92672">.</span>max()
max_rent <span style="color:#f92672">=</span> d[d<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>totalRent<span style="color:#f92672">.</span>max()

ax<span style="color:#f92672">.</span>scatter(x<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>livingSpace_m, c<span style="color:#f92672">=</span>blue, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
              y<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>totalRent_m, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Not Outlier</span><span style="color:#e6db74">&#34;</span>, s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)
ax<span style="color:#f92672">.</span>scatter(x<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>livingSpace_m, c<span style="color:#f92672">=</span>red, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
              y<span style="color:#f92672">=</span>d[d<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>totalRent_m, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Outlier</span><span style="color:#e6db74">&#34;</span>, s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)
ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Using enhanced GMM for Outlier Detection</span><span style="color:#e6db74">&#34;</span>)
ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Living Space [sqm]</span><span style="color:#e6db74">&#34;</span>)
ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Total Rent [€]</span><span style="color:#e6db74">&#34;</span>)
left, right <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>set_xlim(<span style="color:#f92672">-</span><span style="color:#ae81ff">40</span>, max_space <span style="color:#f92672">+</span> <span style="color:#ae81ff">100</span>)
bottom, top <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>set_ylim(<span style="color:#f92672">-</span><span style="color:#ae81ff">500</span>, max_rent <span style="color:#f92672">+</span> <span style="color:#ae81ff">400</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="Outlier%20handling_files/Outlier%20handling_35_0.png" alt="png"></p>
<p>We still remove all the super far out outliers and all flats where either the living space or total rent is very close to zero but now removes much less of the very small but expensive flats (that are probably either in places like Munich or shared flats).
We can have a look at the descriptions of some of the outliers:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">d[[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">regio2</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">description</span><span style="color:#e6db74">&#34;</span>, ]][d<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>head(<span style="color:#ae81ff">10</span>)
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>We see a few objects for which it seems someone just forgot to enter the correct living space. Quite a few others are boarding houses and short term rentals. The lorem ipsum flat for more than 4000€ has also correctly been identified as outlier. There&rsquo;s one penthouse in Munich for 20,000€ where I&rsquo;m not sure if it might be the real total rent, I&rsquo;m not really familiar with rental prices of penthouses.</p>
<h2 id="going-beyond-two-dimensions">Going beyond two dimensions</h2>
<p>A nice thing about the Gaussian mixture outlier detection method is, that it can easily be extended to more than two columns. In this data set for example there are two more variables that also commonly have input errors: the number of rooms and the construction year.
For the construction year, we have different options to use it in our model: either use as is or use the log transformed age of a building. Unfortunately, both ways have disadvantages: If we use the construction year as is, we will detect many very old houses as outliers and even though buildings from the middle age are rare, Germany has quite a few cities with many very old buildings. If instead we use the log transformed age, we miss many outliers: there are for example suspiciously many buildings constructed in 1111. For these kind of outliers, we would need a different approach.
For this analysis, I used the log transformed age and also log transformed the number of rooms. The later helps in identifying cases where the number of rooms is too high for the amount of living space. As a high number of observations also do not have a construction year, I will do this part only on a subset.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">age</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2021.5</span> <span style="color:#f92672">-</span> d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yearConstructed</span><span style="color:#e6db74">&#34;</span>]
d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logAge</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>log(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">age</span><span style="color:#e6db74">&#34;</span>])
d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logRooms</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>log(d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">noRooms</span><span style="color:#e6db74">&#34;</span>])

mask <span style="color:#f92672">=</span> d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logAge</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>notnull()
d_sub <span style="color:#f92672">=</span> d[mask]<span style="color:#f92672">.</span>copy()

d_sub[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nan
d_sub[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> prob_outlier(pipe, d_sub[[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logRent</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logSpace</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logRooms</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">logAge</span><span style="color:#e6db74">&#34;</span>]])
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">d_sub[d_sub<span style="color:#f92672">.</span>outlier <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span>][[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">totalRent</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yearConstructed</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">livingSpace</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">regio2</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">noRooms</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">description</span><span style="color:#e6db74">&#34;</span>]]\
    <span style="color:#f92672">.</span>sort_values(by<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">noRooms</span><span style="color:#e6db74">&#34;</span>, ascending<span style="color:#f92672">=</span>False)\
    <span style="color:#f92672">.</span>head(<span style="color:#ae81ff">10</span>)
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>They are quite a few cases where whole appartment blocks are sold where the living space and total rent then often denotes the living space and total rent of a single unit but the number of rooms denote the number of appartment units that are up for rent.</p>
<p>Let&rsquo;s have a short look at the plot for living space versus number of rooms:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fig, ax  <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>))
d_sub[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier_pred</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(d_sub[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>] <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>)
max_space <span style="color:#f92672">=</span> d_sub[(d_sub<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>) ]<span style="color:#f92672">.</span>livingSpace<span style="color:#f92672">.</span>max()
max_rooms <span style="color:#f92672">=</span> d_sub[(d_sub<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>) ]<span style="color:#f92672">.</span>noRooms<span style="color:#f92672">.</span>max()
ax<span style="color:#f92672">.</span>scatter(x<span style="color:#f92672">=</span>d_sub[d_sub<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>livingSpace_m, c<span style="color:#f92672">=</span>blue, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
              y<span style="color:#f92672">=</span>d_sub[d_sub<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no_outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>noRooms, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Not Outlier</span><span style="color:#e6db74">&#34;</span>, s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)
ax<span style="color:#f92672">.</span>scatter(x<span style="color:#f92672">=</span>d_sub[d_sub<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>livingSpace_m, c<span style="color:#f92672">=</span>red, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
              y<span style="color:#f92672">=</span>d_sub[d_sub<span style="color:#f92672">.</span>outlier_pred <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">outlier</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>noRooms, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Outlier</span><span style="color:#e6db74">&#34;</span>, s<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)

left, right <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>set_xlim(<span style="color:#f92672">-</span><span style="color:#ae81ff">40</span>, max_space <span style="color:#f92672">+</span> <span style="color:#ae81ff">200</span>)
bottom, top <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>set_ylim(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, max_rooms <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>)
ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Living Space [sqm]</span><span style="color:#e6db74">&#34;</span>)
ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Number of Rooms</span><span style="color:#e6db74">&#34;</span>)
ax<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Enhanced Outlier Detection</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> Number of Rooms vs Living Space</span><span style="color:#e6db74">&#34;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="Outlier%20handling_files/Outlier%20handling_42_0.png" alt="png"></p>
<p>The method identifies everything with more than 15 rooms as outlier and cases with a a very small living space (around less than 30sqm) with too many rooms as outliers. Great! It also thinks that flats with a very large living area above e.g. 100sqm but with only one room are likely outliers. That sounds very reasonable to  me.</p>
<h2 id="summary">Summary</h2>
<p>In general, outlier detection is a hard problem: what constitutes an outlier is often not very obvious and can depend on the context. I found it useful to check a few cases by hand and see if I can identify an underlying cause. Sometimes, we can use our own domain knowledge and then identify these problematic cases in a more efficient way. For example, in this data set there are many shared flats with misleading values for the living space. A simple regex or more sophisticated text analysis on the description might be more efficient to identify these cases.</p>
<p>In my experience, results improve significantly if variables are transformed appropriately. Both the Gaussian mixture method and the IQR rule assume that our data follows a normal distribution and results are suboptimal if our data does not. Of course, there are other outlier detection methods that don&rsquo;t assume normality but they always assume something and it is important to be aware of assumptions and make sure they are met.
The assumptions then also determine what kind of outliers we can detect. As the methods used in this analysis assume normality and define outliers as points that are outside the center, it won&rsquo;t detect outliers such as flats built in 1111. There might be real flats build in 1111 and there definitely are quite a few real offers in this data built aroud the 10th century but most flats built in 1111 in this data set are probably not that old.</p>

    
    </section>


  <aside class="read-next">
  
      <a class="read-next-story" style="no-cover" href="/post/outlier-handling/">
          <section class="post">
              <h5>House-Cleaning: Getting rid of outliers with Gauss</h5>
              
          </section>
      </a>
  
  
      <a class="read-next-story prev" style="no-cover" href="/post/conference-time-predictive-analytics-world-2019/">
          <section class="post">
              <h5>Conference Time: Predictive Analytics World 2019</h5>
          </section>
      </a>
      

</aside>



  <footer class="post-footer">


    









<section class="author">
  <h4><a href="/">Corrie</a></h4>
  
  <p>Read <a href="/">more posts</a> by this author.</p>
  
  <div class="author-meta">
    
    
  </div>
</section>




    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=House-Cleaning%3a%20Getting%20rid%20of%20outliers%20with%20Gauss&nbsp;-&nbsp;Samples%20of%20Thoughts&amp;url=%2fpost%2foutlier%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=%2fpost%2foutlier%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=%2fpost%2foutlier%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    

<div id="disqus_thread"></div>
<script>




var disqus_config = function () {
this.page.url = "\/post\/outlier\/";  
this.page.identifier = "\/post\/outlier\/"; 
};

(function() { 
var d = document, s = d.createElement('script');
s.src = 'https://corriebar-github-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>








  </footer>
</article>

</main>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Samples of Thoughts</a> </section>
        
    </footer>
    </div>
    <script type="text/javascript" src="/js/jquery.js"></script>
    <script type="text/javascript" src="/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/js/index.js"></script>
    
    
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
    });
    </script>
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML">
</script>


    
    
<script type="application/javascript">
var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
var doNotTrack = (dnt == "1" || dnt == "yes");
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-140745376-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>

</body>
</html>

